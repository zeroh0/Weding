<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ProductDao">

	<!-- 펀딩예정 상품 갯수 조회    *펀딩예정, 펀딩중, 펀딩종료 상품 갯수 조회문 하나로 해도 될 듯..?
		 작성자 - 장동호 -->
	<select id="beforeFundListTotal" resultType="int"> 
		select count(*) from product where p_condition = 1
	</select>
	
	
	<!-- 펀딩중/펀딩종료 상품 갯수 조회
		작성자 - 장동호 -->
	<select id="fundingListTotal" resultType="int"> 
		select count(*) from product where p_condition = #{p_condition} and mini_cat = #{mini_cat}
	</select>
	
	
	<!-- 펀딩내역 갯수 조회
		 작성자 - 장동호 -->
	<select id="payListTotal" resultType="int">
		select count(*) from ORDERS where ID = 'hong006'
	</select>
	
	
	<!-- 카테고리별 펀딩 상품 조회
		 작성자 - 조소현, 장동호 -->
	<select id="productList" parameterType="Product" resultType="Product">
		<![CDATA[SELECT p.*, c1.c_content main_content, c2.c_content mini_content,
				round((p_currentprice /p_goalprice)*100,2) attainment,
				round(to_date(p_end)-sysdate,0) leftdate
		FROM (SELECT rownum rn, a.*
				FROM (SELECT *
					  FROM product
					  where main_cat = #{main_cat}]]>
					  <choose>
				      <when test="p_condition != 1">
				      	<if test="mini_cat == 999">
				      	<![CDATA[and mini_cat not in #{mini_cat}]]>
				      	</if>
				      	<if test="mini_cat != 999">
				      	 <![CDATA[and mini_cat = #{mini_cat}]]>
				      	</if>
					  </when>
					  <when test="p_condition == 1">
					 <![CDATA[ and mini_cat not in (#{mini_cat}) ]]>
					  </when>
					  </choose>
					   <![CDATA[ and p_condition = #{p_condition}
					  order by P_NUM) a) p,
			(select * from cat where mini_cat='999') c1, 
  		    (select * from cat where mini_cat<>'999') c2
				 WHERE rn between #{start} AND #{end}
				 and   p.main_cat = c1.main_cat
				 and   p.main_cat = c2.main_cat
				 and   p.mini_cat = c2.mini_cat]]>
	</select>
	
	
	<!-- 펀딩 내역 조회
		 작성자 - 장동호 -->
	<select id="payListAll" resultType="Orders">
		select *
		from (select ROWNUM rn, a.*
		      from (select o.O_NUM, o.O_PAYDAY, p.p_name, o.O_SUM, p.P_CONDITION, o.O_SHIPSTATUS, o.id, o.p_num
		            from ORDERS o, PRODUCT p
		            where o.P_NUM = p.P_NUM
		            and o.ID = 'hong006'
		            order by O_NUM desc, O_PAYDAY desc) a
		      )
		where rn between #{start} and #{end}
	</select>
	
	
	<!-- 펀딩 취소
		 작성자 - 장동호 -->
	<delete id="payDelete" parameterType="Orders">
		delete
		from ORDERS
		where ID = #{id}
		and P_NUM = #{p_num}
	</delete>
	
	
	<!-- 메인 랜덤상품 조회
		 작성자 - 장동호 -->
	<select id="getRandomProduct" resultType="Product">
		<![CDATA[
		select *
		from (select *
		      from PRODUCT
		      where P_CONDITION = '2'
		      order by DBMS_RANDOM.VALUE())
		where ROWNUM <= 6
		]]>
	</select>
	
	
	<!-- 메인 인기상품 조회
		 작성자 - 장동호 -->
	<select id="getPopularProduct" resultType="Product">
		<![CDATA[
		select *
		from PRODUCT
		where P_NUM in (select P_NUM
		                from (select p.P_NUM, count(p.P_NUM)
		                      from PRODUCT p, DIBS d
		                      where p.P_NUM = d.P_NUM
		                      group by p.P_NUM
		                      order by count(p.P_NUM) desc, P_NUM)
		                where ROWNUM <= 5)
		]]>
	</select>
	
	
	<!-- 메인 당일오픈 상품 조회
		 작성자 - 장동호 -->
	<select id="getOpenProduct" resultType="Product">
		<![CDATA[
			select *
			from PRODUCT
			where P_START = (select to_char(sysdate, 'yy/mm/dd') from dual)
			and ROWNUM <= 6
		]]>
	</select>
	
	
	<!-- 메인 리뷰가 있는 상품 조회
		 작성자 - 장동호 -->
	<select id="getReviewProduct" resultType="Product">
		<![CDATA[
			select *
			from PRODUCT
			where P_NUM in (select distinct (P_NUM)
			                from BOARD
			                where MAIN_CAT = '300'
			                and MINI_CAT = '400')
			and ROWNUM <= 6
		]]>
	</select>
	
	
	<!-- 상품 카테고리 조회
		 작성자 - 장동호 -->
	<select id="arrayCategoryList" resultType="Cat">
		select * from cat where main_cat = 200 order by mini_cat
	</select>
	
	
	<!-- 펀딩내역 조회
		 작성자 - 장동호 -->
	<insert id="ordersInformation" parameterType="Orders">
		insert into ORDERS (ID, P_NUM, O_NUM, O_QTY, O_SUM, O_PHONE, O_ZIPCODE, O_ROADADDRESS, O_DETAILADDRESS, O_PAYDAY, O_SHIPSTATUS)
		values (#{id}, #{p_num}, #{o_num}, #{o_qty}, #{o_sum}, #{o_phone}, #{o_zipcode}, #{o_roadAddress}, #{o_detailAddress}, sysdate, '상품준비중') 
	</insert>
	
	
	<!-- 주문: 현재달성금액 증가
		 작성자 - 장동호 -->
	<update id="sumCurPrice" parameterType="Orders"> 
		update PRODUCT
		set P_CURRENTPRICE = P_CURRENTPRICE + #{o_sum}
		where P_NUM = #{p_num}
	</update>
	
	
	<!-- 주문: 현재달성금액 감소
		 작성자 - 장동호 -->
	<update id="subCurPrice" parameterType="Orders"> 
		update PRODUCT
		set P_CURRENTPRICE = P_CURRENTPRICE - #{o_sum}
		where P_NUM = #{p_num}
	</update>
	
	
	<!-- 마이페이지: 찜목록 조회
		 작성자 - 김태근 -->
	<select id="dibsListAll" parameterType="Product" resultType="Product">
		<![CDATA[
			SELECT m.id consumer_id, c1.c_content main_content, c2.c_content mini_content, 
				   round((p.p_currentprice /p.p_goalprice)*100,2) attainment, 
				   (case when round(to_date(p_end)-sysdate,0)<0 then '판매종료' else  to_char(round(to_date(p_end)-sysdate,0))||'일 남음' end) leftdate,
			       p.*
			FROM  (SELECT * FROM member WHERE id = 'hong001') m,
			      product p, 
			      (SELECT * FROM cat WHERE mini_cat = '999') c1, 
			      (SELECT * FROM cat WHERE mini_cat <> '999') c2,
			      dibs d
			WHERE  m.id = d.id
			AND    d.p_num = p.p_num
			AND    p.main_cat = c1.main_cat 
			AND    p.main_cat = c2.main_cat 
			AND    p.mini_cat = c2.mini_cat
		]]>
	</select>
	
	<!-- product total(김태근) -->
	<select id="productTotal" resultType="int">
		select Count(*) FROM product
	</select>
	
	<!-- 관리자페이지: 전체상품관리 List
		 작성자 - 김태근 -->
	<select id="allProductListAll" parameterType="Product" resultType="Product">
		<![CDATA[
			SELECT m.id consumer_id, p.*, c2.c_content mini_content, round((p.p_currentprice /p.p_goalprice)*100,0) attainment
			FROM  (SELECT * FROM member WHERE id = 'admin') m,
				  (SELECT rownum rn ,  a.* 
				   FROM  (select * from product order by p_num) a) p,
			      (select * from cat where mini_cat = '999') c1,
			      (select * from cat where mini_cat <> '999') c2
			WHERE rn between #{start} AND  #{end}
			and   p.main_cat = c1.main_cat
			and   p.main_cat = c2.main_cat
			and   p.mini_cat = c2.mini_cat
		]]>
	</select>
	
	
	<!-- 관리자페이지: 전체상품중 해당 상품 UpdateForm
		 작성자  - 김태근 -->
	<select id="allProductUpdateForm" parameterType="Product" resultType="Product">
		<![CDATA[
			    select m.id consumer_id, p.*
			    from  (SELECT * FROM member WHERE id = 'admin') m,
			    	   product p,
			          (select * from cat where mini_cat = '999') c1,
			          (select * from cat where mini_cat <> '999') c2
			    where p.p_num = #{p_num}
			    and   p.main_cat = c1.main_cat
			    and   p.main_cat = c2.main_cat
			    and   p.mini_cat = c2.mini_cat
		]]>
	</select>
	
	
	<!-- 관리자페이지: 전체상품중 해당 상품Update
	 	 작성자 - 김태근 -->
	<update id="allProductUpdate" parameterType="Product">
		update product 
		set  mini_cat = #{mini_cat}, p_store = #{p_store}, p_name = #{p_name}, 
			 p_image1 = #{p_image1}, p_image2 = #{p_image2}, p_description = #{p_description},
			 p_price = #{p_price}
		where p_num = #{p_num}
	</update>
	
	
	<!-- 관리자페이지: 전체상품중에 해당 상품 Delete
		 작성자 - 김태근 -->
		<!-- DIBS값을 count -> DIBS값이 null이 아니면 삭제 -->
		<select id="tgSeleteDibs" resultType="int">
		select Count(*) FROM DIBS where p_num = #{p_num}
		</select>
		<delete id="tgDeleteDibs" parameterType="String">
			delete from DIBS where p_num=#{p_num}
		</delete>
		
		<!-- board값을 count ->board값이 null이 아니면 삭제 -->
		<select id="tgSeleteboard" resultType="int">
			select Count(*) FROM board where p_num = #{p_num}
		</select>
		<delete id="tgDeleteboard" parameterType="String">
			delete from board where p_num=#{p_num}
		</delete>
		
		<!-- alarm값을 count -> alarm값이 null이 아니면 삭제 -->
		<select id="tgSeleteAlarm" resultType="int">
			select Count(*) FROM alarm where p_num = #{p_num}
		</select>
		<delete id="tgDeleteAlarm" parameterType="String">
			delete from alarm where p_num=#{p_num}
		</delete>
		
		<!-- orders값을 count -> orders값이 null이 아니면 삭제 -->
		<select id="tgSeleteOrders" resultType="int">
			select Count(*) FROM orders where p_num = #{p_num}
		</select>
		<delete id="tgDeleteOrders" parameterType="String">
			delete from orders where p_num=#{p_num}
		</delete>
		
		<!-- 위에 상품에 해당하는 게시글, 찜하기, 주문 삭제가 완료되면 product 삭제 -->
		<delete id="tgDeleteProduct" parameterType="String">
			delete from product where p_num=#{p_num}
		</delete>

</mapper>